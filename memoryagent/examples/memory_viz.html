<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memory Agent — Live Console</title>
    <style>
      :root {
        --ink: #0f1214;
        --paper: #f7f2e9;
        --accent: #ff6f3c;
        --accent-2: #1f7a8c;
        --muted: #6f6a63;
        --hot: #ff9f1c;
        --cold: #3b82f6;
        --archive: #8b5cf6;
        --radius: 16px;
        --shadow: 0 18px 40px rgba(14, 14, 20, 0.12);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Space Grotesk", "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #f9f0e2 0%, #f3f6fb 60%, #f8f4ff 100%);
        color: var(--ink);
        min-height: 100vh;
        padding: 28px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 20px;
        margin-bottom: 20px;
      }

      .title h1 {
        font-size: clamp(26px, 4vw, 40px);
        letter-spacing: -0.02em;
      }

      .title p {
        color: #433f3a;
        margin-top: 6px;
        max-width: 520px;
      }

      .metrics {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .metric {
        background: #fff;
        border-radius: var(--radius);
        padding: 10px 14px;
        box-shadow: var(--shadow);
        font-size: 12px;
      }

      .metric strong {
        display: block;
        font-size: 16px;
        margin-top: 4px;
      }

      .layout {
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 18px;
      }

      .panel {
        background: #fff;
        border-radius: var(--radius);
        padding: 18px;
        box-shadow: var(--shadow);
      }

      .panel.chat {
        align-self: start;
      }

      .panel h2 {
        font-size: 15px;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .chat {
        display: grid;
        gap: 12px;
      }

      .chat-shell {
        background: #f4efe6;
        border: 1px solid #e7dfd3;
        border-radius: 14px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: 260px;
      }

      .chat-window {
        display: grid;
        gap: 10px;
        max-height: 500px;
        min-height: 340px;
        overflow-y: auto;
        padding: 8px;
        background: #fffaf2;
        border-radius: 10px;
        border: 1px solid #eee6d9;
        order: 1;
        flex: 1;
      }

      .bubble {
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 12px;
        line-height: 1.45;
        border: 1px solid #e8e1d6;
      }

      .bubble.placeholder {
        background: #fff7ec;
        color: #6f6a63;
        font-style: italic;
        text-align: center;
      }

      .bubble.user {
        background: #ffffff;
        justify-self: end;
        max-width: 80%;
      }

      .bubble.agent {
        background: #f3f7ff;
        justify-self: start;
        max-width: 80%;
      }

      .chat-input {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px;
        align-items: center;
        margin-top: 4px;
        order: 2;
      }

      .chat-input input {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #e1d8cc;
        font-size: 12px;
        width: 100%;
      }

      .chat-input button {
        padding: 10px 14px;
        border-radius: 10px;
        border: none;
        background: var(--ink);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
        font-size: 12px;
      }

      .memory-list {
        display: grid;
        gap: 10px;
      }

      .memory-item {
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid #efe7dd;
        background: #fffdf8;
        display: grid;
        gap: 6px;
        max-width: 520px;
      }

      .memory-item h3 {
        font-size: 13px;
      }

      .memory-item p {
        font-size: 11px;
        color: #4d4842;
      }

      .trace-box {
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 12px;
        background: #f7f1e7;
        border: 1px solid #e5dccf;
        font-size: 11px;
        color: #4d4842;
        display: grid;
        gap: 6px;
      }

      .memory-meta {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        font-size: 10px;
        color: var(--muted);
      }

      .pill {
        padding: 4px 8px;
        border-radius: 999px;
        background: #f2ede5;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      @media (max-width: 980px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }

        .layout {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="title">
        <h1>Live Memory Console</h1>
        <p>Chat with your agent and see the relevant memories update in real time.</p>
      </div>
      <div class="metrics">
        <div class="metric"><span>Total</span><strong id="stat-total">0</strong></div>
        <div class="metric"><span>Hot Hit</span><strong id="stat-hot">0%</strong></div>
        <div class="metric"><span>Archive</span><strong id="stat-archive">0</strong></div>
      </div>
    </header>

    <section class="layout">
      <div class="panel chat">
        <h2>Agent Chat</h2>
        <div class="chat-shell">
          <div class="chat-window" id="chat-window"></div>
          <div class="chat-input">
            <input id="chat-input" type="text" placeholder="Ask the agent..." />
            <button id="chat-send">Send</button>
          </div>
        </div>
        <div class="trace-box" id="trace-box">Trace: waiting for first reply.</div>
      </div>

      <div class="panel">
        <h2>User Memories</h2>
        <div class="memory-list" id="memory-list"></div>
      </div>
    </section>

    <script>
      async function loadData(owner = "user-001") {
        const response = await fetch(`/api/memory?owner=${encodeURIComponent(owner)}`);
        if (!response.ok) {
          throw new Error("Failed to load /api/memory");
        }
        return response.json();
      }

      function renderStats(data) {
        const total = data.hot_items?.length || 0;
        document.getElementById("stat-total").textContent = total;
        document.getElementById("stat-hot").textContent = `${data.metrics?.hot_hit_rate ?? 0}%`;
        document.getElementById("stat-archive").textContent = data.metrics?.archive_escalations ?? 0;
      }

      function renderMemoryList(data) {
        const container = document.getElementById("memory-list");
        container.innerHTML = "";
        const items = (data.hot_items || []).slice(0, 20);
        items.forEach((item) => {
          const card = document.createElement("div");
          card.className = "memory-item";
          card.innerHTML = `
            <h3>${item.summary || "Untitled memory"}</h3>
            <p>${item.content ? JSON.stringify(item.content) : ""}</p>
            <div class="memory-meta">
              <span class="pill">${item.type}</span>
              <span class="pill">${item.tier}</span>
              <span>Confidence ${(item.confidence * 100).toFixed(0)}%</span>
            </div>
          `;
          container.appendChild(card);
        });
      }

      function addBubble(text, role) {
        const container = document.getElementById("chat-window");
        const bubble = document.createElement("div");
        bubble.className = `bubble ${role}`;
        bubble.textContent = text;
        container.appendChild(bubble);
        container.scrollTop = container.scrollHeight;
      }

      async function sendChat(message, owner = "user-001") {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ owner, message }),
        });
        if (!response.ok) {
          throw new Error("Chat request failed");
        }
        return response.json();
      }

      function setupChat(owner = "user-001") {
        const input = document.getElementById("chat-input");
        const button = document.getElementById("chat-send");
        const container = document.getElementById("chat-window");
        const traceBox = document.getElementById("trace-box");
        if (!container.children.length) {
          addBubble("Start a conversation to see replies here.", "placeholder");
        }

        async function handleSend() {
          const text = input.value.trim();
          if (!text) return;
          const placeholder = container.querySelector(".bubble.placeholder");
          if (placeholder) {
            placeholder.remove();
          }
          addBubble(text, "user");
          input.value = "";
          try {
            const result = await sendChat(text, owner);
            addBubble(result.reply, "agent");
            if (result.trace) {
              const parts = [
                result.trace.confidence != null ? `confidence=${result.trace.confidence.toFixed(2)}` : null,
                result.trace.steps?.length ? `steps=${result.trace.steps.join(" → ")}` : null,
                result.trace.escalations?.length ? `escalations=${result.trace.escalations.join(", ")}` : null,
                result.trace.sources?.length ? `sources=${result.trace.sources.join(", ")}` : null,
              ].filter(Boolean);
              traceBox.textContent = parts.length ? `Trace: ${parts.join(" | ")}` : "Trace: none.";
            }
            const refreshed = await loadData(owner);
            renderStats(refreshed);
            renderMemoryList(refreshed);
          } catch (error) {
            addBubble(`Error: ${error.message}`, "agent");
          }
        }

        button.addEventListener("click", handleSend);
        input.addEventListener("keydown", (event) => {
          if (event.key === "Enter") handleSend();
        });
      }

      const owner = "user-001";
      loadData(owner)
        .then((data) => {
          renderStats(data);
          renderMemoryList(data);
          setupChat(owner);
        })
        .catch((error) => {
          document.getElementById("memory-list").textContent = error.message;
        });
    </script>
  </body>
</html>
